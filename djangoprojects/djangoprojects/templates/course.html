{% extends "base.html" %}
{% block title %}課程詳情 - {{ course.code }}{% endblock %}
{% block content %}
<h1>{{ course.code }} - {{ course.name }}</h1>
<p>任課教師：{% if course.teacher and course.teacher.user %}{{ course.teacher.user.username }}{% else %}<span class="text-muted">未分配</span>{% endif %}</p>

<h2>已修學生</h2>
{% if enrollments %}
  <table class="table">
    <thead>
      <tr>
        <th>學生</th>
        <th>期中</th>
        <th>期末</th>
        <th>動作</th>
      </tr>
    </thead>
    <tbody>
      {% for e in enrollments %}
        <tr>
          <td>{{ e.student.username }}</td>
          {% if user.is_authenticated %}
            {% if user.is_staff or user == e.student or course.teacher and user == course.teacher.user %}
            <td>{{ e.midtrem_grade|default:'-' }}</td>
            <td>{{ e.final_grade|default:'-' }}</td>
            <td>
              <form method="post" action="{% url 'enroll_course' %}">
                  {% csrf_token %}
                  <input type="hidden" name="course_id" value="{{ course.id }}">
                  <input type="hidden" name="action" value="drop">
                  {% if user.is_staff or course.teacher and user == course.teacher.user %}
                    {# staff or assigned teacher operating on behalf of a student - include student_id #}
                    <input type="hidden" name="student_id" value="{{ e.student.id }}">
                  {% endif %}
                  <button class="btn btn-sm btn-danger" type="submit">退選</button>
                </form>
            </td>
            {% else %}
            <td colspan="3"><em class="text-muted">僅限本人或授課教師可見</em></td>
            {% endif %}
          {% else %}
            <td colspan="3"><em class="text-muted">請先登入以查看學生與加退選選項</em></td>
          {% endif %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>尚無學生修課。</p>
{% endif %}

<hr>
<h3>加選學生</h3>
  {% if user.is_authenticated %}
  {% if user.is_staff or course.teacher and user == course.teacher.user %}
    {# teacher/admin: enroll other students #}
    {% if other_students %}
    <form method="post" action="{% url 'enroll_course' %}">
      {% csrf_token %}
      <input type="hidden" name="course_id" value="{{ course.id }}">
      <div class="input-group mb-3">
        <select name="student_id" class="form-select">
          {% for s in other_students %}
            <option value="{{ s.id }}">{{ s.username }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="action" value="enroll">
        <button class="btn btn-primary" type="submit">加選學生</button>
      </div>
    </form>
    {% else %}
      <p>沒有可加選的學生。</p>
    {% endif %}
  {% else %}
    {# regular authenticated student: allow self-enroll if not already enrolled #}
    {% if user in other_students %}
      <form method="post" action="{% url 'enroll_course' %}">
        {% csrf_token %}
        <input type="hidden" name="course_id" value="{{ course.id }}">
        <input type="hidden" name="action" value="enroll">
        <button class="btn btn-success">加選（加入此課）</button>
      </form>
    {% else %}
      <p class="text-muted">您已經選修此課或無法加選。</p>
    {% endif %}
  {% endif %}
{% endif %}

<hr>
<h3>課程留言</h3>
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'add_comment' course.id %}">
    {% csrf_token %}
    {{ comment_form.as_p }}
    <button class="btn btn-primary">留言</button>
  </form>
{% else %}
  <p>請先 <a href="{% url 'login' %}">登入</a> 才能留言。</p>
{% endif %}

  {% if comments %}
  <ul class="list-group mt-3">
    {% for c in comments %}
      <li class="list-group-item">
        <div class="d-flex justify-content-between">
          <div>
            <strong>{{ c.user.username }}</strong> <small class="text-muted">{{ c.created_at }}</small>
            <div>{{ c.content|linebreaks }}</div>
          </div>
          <div>
            {% if c.user == user or user.is_staff %}
              <a href="{% url 'edit_comment' c.id %}" class="btn btn-sm btn-outline-secondary">編輯</a>
              <form method="post" action="{% url 'delete_comment' c.id %}" style="display:inline;">
                {% csrf_token %}
                <button class="btn btn-sm btn-danger" onclick="return confirm('確定刪除?')">刪除</button>
              </form>
            {% endif %}
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted mt-3">目前尚無留言。</p>
{% endif %}
{% endblock %}
